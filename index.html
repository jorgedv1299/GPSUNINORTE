<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS UNINORTE</title>
    <style>
        body {
            font-family: Roboto, sans-serif;
            margin: 0;
            padding: 0;
            text-align: center;
            background-color: #12025a;
        }

        .container {
            padding: 20px;
            background-color: #0cc782;
            margin: 50px auto;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            max-width: 1200px;
            display: none; /* Secciones ocultas por defecto */
        }

        h1 {
            color: #333;
        }

        #map-realtime, #map-route, #map-search {
            height: 80vh; /* Ajustado para dar más protagonismo al mapa */
            width: 100%;
            margin-top: 20px;
        }

        .input-group {
            margin: 10px 0;
        }

        /* Estilo para el contenedor de botones */
        .nav-container {
            background-color: #444;
            padding: 20px;
            display: flex;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            margin: 20px 0;
        }

        nav select {
            padding: 10px;
            border: 2px solid #444;
            border-radius: 5px;
            background-color: white;
            color: #444;
        }

        nav button {
            margin-left: 10px;
            padding: 10px;
            border: 2px solid #444;
            background-color: #333;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        nav button:hover {
            background-color: #666;
        }

        table {
            margin-top: 20px;
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #444;
            color: white;
        }
        #log {
            background-color: #fff;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>

    <!-- Contenedor de botones -->
    <div class="nav-container">
        <nav>
            <select id="nav-options">
                <option value="">Seleccione una opción</option>
                <option value="realtime">Ver posición en tiempo real</option>
                <option value="search">Buscar recorrido</option>
                <option value="address-search">Buscar por dirección</option>
            </select>
            <button id="select-option">Seleccionar</button>
        </nav>
    </div>
    
    <div class="container" id="realtime-section">
        <h1>GPS<br>Recorrido en tiempo real</h1>
        <div id="location">
            <p><strong>Latitud:</strong> <span id="latitud">Cargando...</span></p>
            <p><strong>Longitud:</strong> <span id="longitud">Cargando...</span></p>
            <p><strong>Timestamp:</strong> <span id="timestamp">Cargando...</span></p>
        </div>
        <div id="map-realtime"></div>
    </div>

    <div class="container" id="search-section">
        <h1>Buscar Recorrido</h1>
        <div class="input-group">
            <label for="start-date">Fecha y hora inicial:</label>
            <input type="datetime-local" id="start-date">
        </div>
        <div class="input-group">
            <label for="end-date">Fecha y hora final:</label>
            <input type="datetime-local" id="end-date">
        </div>
        <button id="show-route">Mostrar recorrido</button>
        <div id="map-route"></div>
    </div>

    <div class="container" id="address-search-section">
        <h1>Buscar por dirección</h1>
        <div class="input-group">
            <label for="address-input">Dirección:</label>
            <input type="text" id="autocomplete" placeholder="Ingrese una dirección">
        </div>
        <button id="search-address">Buscar</button>
        <div id="map-search"></div>
        <h2>Historial de visitas en 40 metros</h2>
        <p id="visit-count"></p>
        <table id="proximity-table">
                <thead>
                        <tr>
                                <th>Fecha</th>
                        </tr>
                </thead>
                <tbody></tbody>
        </table>
      <h2>Log de Envíos</h2>
        <div id="log"></div>
    </div>

    <script>
        let mapRealTime, markerRealTime, realTimePath = [], realTimePolyline;
        let mapRoute, routePolyline;
        let mapSearch, markerSearch;

        function initMapRealTime() {
            mapRealTime = new google.maps.Map(document.getElementById('map-realtime'), {
                zoom: 15,
                center: { lat: 11.0190513, lng: -74.8511425 }
            });
            markerRealTime = new google.maps.Marker({
                position: { lat: 11.0190513, lng: -74.8511425 },
                map: mapRealTime,
                icon: {
                    url: "https://maps.google.com/mapfiles/ms/icons/green-dot.png",
                    scaledSize: new google.maps.Size(30, 30)
                }
            });

            realTimePolyline = new google.maps.Polyline({
                path: realTimePath,
                geodesic: true,
                strokeColor: "#0000FF",
                strokeOpacity: 1.0,
                strokeWeight: 2
            });
            realTimePolyline.setMap(mapRealTime);

            setInterval(() => {
                fetch('get_location.php')
                .then(response => response.json())
                .then(data => {
                    const { latitud, longitud, timestamp } = data;

                    document.getElementById('latitud').innerText = latitud;
                    document.getElementById('longitud').innerText = longitud;
                    document.getElementById('timestamp').innerText = timestamp;

                    const newPosition = { lat: parseFloat(latitud), lng: parseFloat(longitud) };
                    markerRealTime.setPosition(newPosition);
                    mapRealTime.setCenter(newPosition);

                    realTimePath.push(newPosition);
                    realTimePolyline.setPath(realTimePath);
                })
                .catch(error => console.error('Error al obtener la ubicación en tiempo real:', error));
            }, 5000);
        }

        function initMapRoute() {
            mapRoute = new google.maps.Map(document.getElementById('map-route'), {
                zoom: 15,
                center: { lat: 11.0190513, lng: -74.8511425 }
            });

            document.getElementById('show-route').addEventListener('click', () => {
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;

                if (startDate && endDate) {
                    const url = `get_route.php?start=${startDate}&end=${endDate}`;
                    fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        const routePath = data.map(point => ({ lat: parseFloat(point.latitud), lng: parseFloat(point.longitud) }));

                        if (routePolyline) {
                            routePolyline.setMap(null);
                        }

                        routePolyline = new google.maps.Polyline({
                            path: routePath,
                            geodesic: true,
                            strokeColor: "#FF0000",
                            strokeOpacity: 1.0,
                            strokeWeight: 2
                        });
                        routePolyline.setMap(mapRoute);
                        mapRoute.setCenter(routePath[0]);
                    })
                    .catch(error => console.error('Error al obtener el recorrido:', error));
                } else {
                    alert('Por favor, seleccione una fecha de inicio y final.');
                }
            });
        }

        function initMapSearch() {
            mapSearch = new google.maps.Map(document.getElementById('map-search'), {
                    zoom: 15,
                    center: { lat: 11.0190513, lng: -74.8511425 }
            });
    
            const autocomplete = new google.maps.places.Autocomplete(document.getElementById('autocomplete'));
            autocomplete.addListener('place_changed', function () {
                const place = autocomplete.getPlace();
                if (!place.geometry) {
                    alert('No se pudo obtener la ubicación de la dirección seleccionada.');
                    return;
                }
                if (markerSearch) {
                    markerSearch.setMap(null);
                }
                markerSearch = new google.maps.Marker({
                    position: place.geometry.location,
                    map: mapSearch
                });
                mapSearch.setCenter(place.geometry.location);
                getNearbyVisits(place.geometry.location);
            });

            document.getElementById('search-address').addEventListener('click', () => {
                const address = document.getElementById('autocomplete').value;
                if (address) {
                    const geocoder = new google.maps.Geocoder();
                    geocoder.geocode({ address: address }, (results, status) => {
                        if (status === 'OK') {
                            const location = results[0].geometry.location;
                            mapSearch.setCenter(location);
                            if (markerSearch) {
                                markerSearch.setMap(null);
                            }
                            markerSearch = new google.maps.Marker({
                                position: location,
                                map: mapSearch
                            });
                            getNearbyVisits(location);
                        } else {
                            alert('No se encontró la dirección: ' + status);
                        }
                    });
                } else {
                    alert('Por favor, ingrese una dirección.');
                }
            });
        }

        function getNearbyVisits(location) {
            const lat = location.lat();
            const lng = location.lng();
            const url = `get_proximity.php?lat=${lat}&lng=${lng}`;

            fetch(url)
            .then(response => response.json())
            .then(data => {
                const tableBody = document.getElementById('proximity-table').getElementsByTagName('tbody')[0];
                tableBody.innerHTML = ''; // Limpiar tabla anterior

                data.forEach(item => {
                    const row = tableBody.insertRow();
                    const cellDate = row.insertCell(0);
                    const cellSteps = row.insertCell(1);
                    cellDate.innerText = item.date;
                    cellSteps.innerText = item.steps;
                });

                // Mostrar el log
                const logDiv = document.getElementById('log');
                logDiv.innerHTML += `Búsqueda realizada en: ${location}<br>`;
            })
            .catch(error => console.error('Error al obtener visitas cercanas:', error));
        }

        document.getElementById('select-option').addEventListener('click', () => {
            const selectedOption = document.getElementById('nav-options').value;
            document.querySelectorAll('.container').forEach(container => container.style.display = 'none');
            if (selectedOption) {
                const sectionId = selectedOption === 'realtime' ? 'realtime-section' :
                                 selectedOption === 'search' ? 'search-section' :
                                 'address-search-section';
                document.getElementById(sectionId).style.display = 'block';

                // Inicializar el mapa correspondiente
                if (sectionId === 'realtime-section') {
                    initMapRealTime();
                } else if (sectionId === 'search-section') {
                    initMapRoute();
                } else if (sectionId === 'address-search-section') {
                    initMapSearch();
                }
            }
        });
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAuGrfoR6gAB-VTptsOSLSkWX0yllytv4M&libraries=places"></script>
</body>
</html>


