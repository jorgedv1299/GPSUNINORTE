<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS UNINORTE</title>
    <style>
        body {
            font-family: Roboto, sans-serif;
            margin: 0;
            padding: 0;
            text-align: center;
            background-color: #12025a;
        }
        .container {
            padding: 20px;
            background-color: #097f6a;
            margin: 50px auto;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            max-width: 600px;
        }
        h1 {
            color: #333;
        }
        #map {
            height: 400px;
            width: 100%;
            margin-top: 20px;
        }
        .input-group {
            margin: 10px 0;
        }
        nav {
            background-color: #444;
            padding: 10px;
        }
        nav a {
            color: white;
            margin: 0 10px;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <nav>
        <a href="#realtime">Ver posición en tiempo real</a>
        <a href="#search">Buscar recorrido</a>
    </nav>
    
    <div class="container" id="realtime">
        <h1>GPS<br>Recorrido en tiempo real</h1>

        <div id="location">
            <p><strong>Latitud:</strong> <span id="latitud">Cargando...</span></p>
            <p><strong>Longitud:</strong> <span id="longitud">Cargando...</span></p>
            <p><strong>Timestamp:</strong> <span id="timestamp">Cargando...</span></p>
        </div>

        <div id="map"></div>
    </div>

    <div class="container" id="search">
        <h1>Buscar Recorrido</h1>
        
        <div class="input-group">
            <label for="start-date">Fecha y hora inicial:</label>
            <input type="datetime-local" id="start-date">
        </div>

        <div class="input-group">
            <label for="end-date">Fecha y hora final:</label>
            <input type="datetime-local" id="end-date">
        </div>

        <button id="show-route">Mostrar recorrido</button>
    </div>

    <script>
        let map;
        let markerCurrent;
        let realTimePath = [];
        let realTimePolyline;

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 15,
                center: { lat: 0, lng: 0 }
            });
            markerCurrent = new google.maps.Marker({
                position: { lat: 0, lng: 0 },
                map: map,
                icon: {
                    url: "https://maps.google.com/mapfiles/ms/icons/green-dot.png",
                    scaledSize: new google.maps.Size(30, 30)
                }
            });
            realTimePolyline = new google.maps.Polyline({
                path: realTimePath,
                geodesic: true,
                strokeColor: "#0000FF",
                strokeOpacity: 1.0,
                strokeWeight: 2
            });
            realTimePolyline.setMap(map);
        }

        function fetchRoute(startDate, endDate) {
            const url = `get_route.php?start=${startDate}&end=${endDate}`;
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Error en la respuesta de la API");
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.length > 0) {
                        let path = [];
                        data.forEach(point => {
                            const position = { lat: parseFloat(point.latitud), lng: parseFloat(point.longitud) };
                            path.push(position);
                        });
                        new google.maps.Polyline({
                            path: path,
                            geodesic: true,
                            strokeColor: "#FF0000",
                            strokeOpacity: 1.0,
                            strokeWeight: 2
                        }).setMap(map);
                        if (path.length > 0) {
                            map.setCenter(path[0]);
                        }
                    } else {
                        alert('No se encontraron datos en el rango de fechas seleccionado.');
                    }
                })
                .catch(error => {
                    console.error('Error al obtener el recorrido:', error);
                    alert('Error al obtener el recorrido, revisa la consola para más detalles.');
                });
        }

        function updateCurrentLocation(lat, lng, timestamp) {
            const position = { lat: lat, lng: lng };
            markerCurrent.setPosition(position);
            realTimePath.push(position);
            realTimePolyline.setPath(realTimePath);
            map.setCenter(position);
            document.getElementById('latitud').innerText = lat;
            document.getElementById('longitud').innerText = lng;
            document.getElementById('timestamp').innerText = new Date(timestamp).toLocaleString('es-CO');
        }

        document.getElementById('show-route').addEventListener('click', () => {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            if (startDate && endDate) {
                fetchRoute(startDate, endDate);
            } else {
                alert('Por favor selecciona ambas fechas.');
            }
        });

        function getCurrentLocation() {
            fetch('get_location.php')
                .then(response => response.json())
                .then(data => {
                    const { latitud, longitud, timestamp } = data;
                    updateCurrentLocation(parseFloat(latitud), parseFloat(longitud), timestamp);
                })
                .catch(error => {
                    console.error('Error al obtener la ubicación actual:', error);
                });
        }

        setInterval(getCurrentLocation, 10000);

        window.onload = () => {
            initMap();
            getCurrentLocation();
        };
    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAjXW8vBhlpVflxXu1wZaBKYJ3xxeDbOOA&callback=initMap" async defer></script>
</body>
</html>
