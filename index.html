<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS UNINORTE</title>
    <style>
        body {
            font-family: Roboto, sans-serif;
            margin: 0;
            padding: 0;
            text-align: center;
            background-color: #12025a;


            background-color: #760359;
        }
        .container {
            padding: 20px;

            background-color: #097f6a;

            margin: 50px auto;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            max-width: 600px;
            display: none; /* Secciones ocultas por defecto */
        }
        h1 {
            color: #333;
        }
        #map {
            height: 400px;
            width: 100%;
            margin-top: 20px;
        }
        .input-group {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>GPS<br>Recorrido</h1>
        
        <div class="input-group">
            <label for="start-date">Fecha y hora inicial:</label>
            <input type="datetime-local" id="start-date">
        </div>
        <div class="input-group">
            <label for="end-date">Fecha y hora final:</label>
            <input type="datetime-local" id="end-date">
        </div>
        <button id="show-route">Mostrar recorrido</button>

        <div id="location">
            <p><strong>Latitud:</strong> <span id="latitud">Cargando...</span></p>
            <p><strong>Longitud:</strong> <span id="longitud">Cargando...</span></p>
            <p><strong>Timestamp:</strong> <span id="timestamp">Cargando...</span></p>
        </div>

        <div id="map"></div>
    </div>

    <script>
        const apiKey = 'AIzaSyAjXW8vBhlpVflxXu1wZaBKYJ3xxeDbOOA'; // Reemplaza esto con tu clave de API de Google Maps

        let map;
        let marker;
        let path = [];
        let realTimePath = [];
        let realTimePolyline; 
        let markerCurrent;

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 15,
                center: { lat: 0, lng: 0 }
            });
            markerRealTime = new google.maps.Marker({
                position: { lat: 0, lng: 0 },
                map: mapRealTime,
                icon: {
                    url: "https://maps.google.com/mapfiles/ms/icons/green-dot.png",
                    scaledSize: new google.maps.Size(30, 30)
                }
            });

            realTimePolyline = new google.maps.Polyline({
                path: realTimePath,
                geodesic: true,
                strokeColor: "#0000FF",
                strokeOpacity: 1.0,
                strokeWeight: 2
            });
            realTimePolyline.setMap(map);
        }

        function fetchRoute(startDate, endDate) {
            const url = `get_route.php?start=${startDate}&end=${endDate}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        path = [];
                        data.forEach(point => {
                            const position = { lat: parseFloat(point.latitud), lng: parseFloat(point.longitud) };
                            path.push(position);
                        });
                        // Mostrar recorrido en el mapa
                        new google.maps.Polyline({
                            path: path,
                            geodesic: true,
                            strokeColor: "#FF0000",
                            strokeOpacity: 1.0,
                            strokeWeight: 2
                        }).setMap(map); 
                        if (path.length > 0) {
                            map.setCenter(path[0]);
                        }
                    } else {
                        alert('No se encontraron datos en el rango de fechas seleccionado.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function updateCurrentLocation(lat, lng, timestamp) {
            const position = { lat: lat, lng: lng };
            markerCurrent.setPosition(position);
            realTimePath.push(position); // Agregar a la polilínea en tiempo real
            realTimePolyline.setPath(realTimePath);
            map.setCenter(position); // Centrar el mapa en la ubicación actual

            // Actualizar datos de la ubicación
            document.getElementById('latitud').innerText = lat;
            document.getElementById('longitud').innerText = lng;
            document.getElementById('timestamp').innerText = new Date(timestamp).toLocaleString('es-CO'); // Formato de fecha en Colombia
        }

        document.getElementById('show-route').addEventListener('click', () => {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            if (startDate && endDate) {
                fetchRoute(startDate, endDate);
            } else {
                alert('Por favor selecciona ambas fechas.');
            }
        });

        // Función para obtener la ubicación actual cada cierto tiempo
        function getCurrentLocation() {
            fetch('get_location.php') // Endpoint que debes crear para obtener la ubicación actual
                .then(response => response.json())
                .then(data => {
                    const tbody = document.querySelector('#proximity-table tbody');
                    tbody.innerHTML = ''; // Limpiar contenido anterior

                    data.forEach(row => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${row.fecha}</td><td>${row.cantidad}</td>`;
                        tbody.appendChild(tr);
                    });
                })
                .catch(error => console.error('Error al verificar la proximidad:', error));
            };
        

        // Actualiza la ubicación cada 10 segundos
        setInterval(getCurrentLocation, 10000);

        window.onload = () => {
            initMap();
            getCurrentLocation(); // Obtén la ubicación actual al cargar
        };
    </script>

    <!-- Carga el script de Google Maps API -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAjXW8vBhlpVflxXu1wZaBKYJ3xxeDbOOA&callback=initMap"></script>
</body>
</html>
